<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <style>
/* ===== IMPORTA√á√ÉO DAS FONTES DA EGPCE ===== */
@import url('https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Maitree:wght@200;300;400;500;600;700&display=swap');

/* ===== ESTILO PADR√ÉO INICIAL ===== */
body {
    font-family: 'Kanit', 'Maitree', Arial, Helvetica, sans-serif;
}

#resumoBtn {
    background-color: #e06a0c;
    color: #fff;
    font-size: 0.8rem;
}

#programaBtn {
    background-color: #2db39e;
    color: #fff;
    font-size: 0.8rem;
}

#pesquisaBtn {
    background-color: #26a737;
    color: #fff;
    font-size: 0.8rem;
}

#toggleBtn {
    background-color: #fff;
    color: #2db39e;
}
.btn {
    transition: background-color 0.3s, color 0.3s;
    background-color: #2db39e;
    color: #fff;
}

.btn:hover {
    background-color: #228677;
    color: #fff;
}

.chat-messages {
  background-color: #eee9e9 !important;
  color: #000 !important;
  border-radius: 5rem;
  border-color: #bbb;
}

/* ====== MODO CLARO ====== */
body.light-mode {
  background-color: #fff;
  color: #000;
  transition: background-color 1s, color 1s;
}

body.light-mode p {
  color: #000;
  transition: color 1s;
}

body.light-mode #sidebar {
  background-color: #fff;
  color: #000;
}

body.light-mode #chatContent {
  background-color: #fff;
  color: #000;
}

body.light-mode .chat-messages {
  background-color: #eee9e9 !important;
  color: #000 !important;
  border-color: #bbb;
}

body.light-mode .btn {
  background-color: #2db39e;
  color: #fff;
}

/* ====== MODO ESCURO ====== */
body.dark-mode {
  background-color: #333;
  color: #fff;
  transition: background-color 1s, color 1s;
}

body.dark-mode p {
  color: #fff;
}

body.dark-mode #sidebar {
  background-color: #262626;
  color: #fff;
}

body.dark-mode #chatContent {
  background-color: #262626;
  color: #fff;
  border-color: #444;
}

body.dark-mode .chat-messages {
  background-color: #333 !important;
  color: #fff !important;
}

body.dark-mode .btn {
  background-color: #555;
  color: #fff;
}


  </style>
</head>

<body>
  <div class="container mt-3">
    <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
      aria-controls="sidebar">
      ü§ñChatbot
    </button>
  </div>
  <aside class="offcanvas offcanvas-end" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <button class="btn btn-close mx-4" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      <h2 class="offcanvas-title">ü§ñChatbot</h2>
      <button class="btn float-end z-2 border-secondary mx-4" id="toggleBtn" onclick="modoescuro()">üåô</button>
    </div>
    <div class="offcanvas-body" id="chatbot">
      <p><strong>Bem Vindo! Escolha seu modelo de l√≥gica:</strong></p>
      <div class="container-fluid mt-4">
        <div class="d-flex justify-content-center">
          <div class="card mx-2 w-sm-25">
            <button class="btn w-auto" id="resumoBtn" onclick="toggleLogic('resumo')">Resumos</button>
          </div>
          <div class="card mx-2 w-sm-25">
            <button class="btn w-auto" id="programaBtn" onclick="toggleLogic('programa')">Programa√ß√£o</button>
          </div>
          <div class="card mx-2 w-sm-25">
            <button class="btn w-auto" id="pesquisaBtn" onclick="toggleLogic('pesquisa')">Pesquisas</button>
          </div>
        </div>
      </div>
      <div id="chatContent" class="mt-4">

      </div>
    </div>
  </aside>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>
  <script>
    function modoescuro() {
    document.body.classList.add("dark-mode");
    document.body.classList.remove("light-mode");

    document.getElementById("toggleBtn").innerHTML = "üåû";
    document.getElementById("toggleBtn").setAttribute("onclick", "modolight()");
}

function modolight() {
    document.body.classList.add("light-mode");
    document.body.classList.remove("dark-mode");

    document.getElementById("toggleBtn").innerHTML = "üåô";
    document.getElementById("toggleBtn").setAttribute("onclick", "modoescuro()");
}


/* ===== Antes de tudo, √± mexe aqui pq se √± o chatbot √± funciona! ===== */

const chatbotDiv = document.getElementById('chatContent');

// Fun√ß√£o que altera as l√≥gicas de resposta do Chatbot (Alterar essa parte pode resultar em uma oculta√ß√£o do Chatbot)
function toggleLogic(mode) {
    if (mode === 'resumo') {
        chatbotDiv.innerHTML = `
            <div class="chat-container">
                <h4 class="text-center mb-3">üí° Modo Resumo</h4>
                <div class="chat-messages" id="resumoMessages" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                    <div class="message bot-message">
                        <strong>ü§ñ Assistente:</strong> Ol√°! Sou especialista em criar resumos. Sobre qual assunto voc√™ gostaria de um resumo?
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="resumoInput" class="form-control" placeholder="Digite sua pergunta sobre resumos..." aria-label="Digite sua pergunta">
                    <button class="btn btn-success" onclick="sendMessage('resumo')">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
            </div>
        `;
    } else if (mode === 'programa') {
        chatbotDiv.innerHTML = `
            <div class="chat-container">
                <h4 class="text-center mb-3">üíª Modo Programa√ß√£o</h4>
                <div class="chat-messages" id="programaMessages" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                    <div class="message bot-message">
                        <strong>ü§ñ Assistente:</strong> Ol√°! Sou especialista em programa√ß√£o. Como posso ajudar com c√≥digo hoje?
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="programaInput" class="form-control" placeholder="Digite sua d√∫vida de programa√ß√£o..." aria-label="Digite sua pergunta">
                    <button class="btn btn-success" onclick="sendMessage('programa')">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
            </div>
        `;
    } else if (mode === 'pesquisa') {
        chatbotDiv.innerHTML = `
            <div class="chat-container">
                <h4 class="text-center mb-3">üîç Modo Pesquisa</h4>
                <div class="chat-messages" id="pesquisaMessages" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                    <div class="message bot-message">
                        <strong>ü§ñ Assistente:</strong> Ol√°! Sou especialista em pesquisas. Sobre qual tema voc√™ gostaria de pesquisar?
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="pesquisaInput" class="form-control" placeholder="Digite sua pergunta de pesquisa..." aria-label="Digite sua pergunta">
                    <button class="btn btn-success" onclick="sendMessage('pesquisa')">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
            </div>
        `;
    }
    const inputField = document.getElementById(`${mode}Input`);
    if (inputField) {
        inputField.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault(); 
                sendMessage(mode);  
            }
        });
    }
}

// L√≥gicas de resposta do Chatbot (Alterar essa parte pode resultar em um erro de funcionamento do Chatbot ou uma modifica√ß√£o na forma que ele fala)
const modeConfig = {
    resumo: {
        model: "openai/gpt-4o-mini",
        system: "Voc√™ √© uma especialista em criar resumos claros, objetivos e did√°ticos para estudantes. Sempre responde de forma concisa e direta, destacando os pontos principais do assunto abordado."
    },
    programa: {
        model: "deepseek/deepseek-chat-v3.1",
        system: "Voc√™ √© uma programadora experiente. Sempre responde com c√≥digo bem explicado, comentado e com exemplos pr√°ticos. Tem conhecimento em v√°rias linguagens de programa√ß√£o, frameworks, bibliotecas, APIs, Banco de Dados, HTML, CSS, JavaScript, Python, Java, C++, Ruby, PHP, SQL, entre outras."
    },
    pesquisa: {
        model: "google/gemini-2.5-flash-lite",
        system: "Voc√™ √© uma assistente de pesquisa acad√™mica. Responda de forma anal√≠tica, detalhada e, principalmente, sempre citando refer√™ncias e as fontes com os respectivos links."
    }
};

// Chaves de API (Essas chaves s√£o reais! N√£o podem ser compartilhadas, alteradas, expostas e nem clicadas se n√£o vai dar um trabalh√£o reconfigurar tudo)
const apiKeys = {
    openrouter: "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",
    openrouter2: "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",
    openrouter3: "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"
};


// Fun√ß√£o que chama a API do OpenRouter (Alterar essa parte pode resultar em um erro de conex√£o do Chatbot com a API)
async function callOpenRouter({ model, system, userMessage, apiKey }) {
    const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json",
            "HTTP-Referer": location.origin,
            "X-Title": "Meu Chatbot"
        },
        body: JSON.stringify({
            model,
            messages: [
                { role: "system", content: system },
                { role: "user", content: userMessage }
            ]
        })
    });

    let data = null;
    try { data = await resp.json(); } catch (_) { }

    if (!resp.ok) {
        const msg = data?.error?.message || data?.message || `${resp.status} ${resp.statusText}`;
        throw new Error(`OpenRouter: ${msg}`);
    }
    const content = data?.choices?.[0]?.message?.content?.trim();
    return content || "";
}

// Fun√ß√£o que formata a resposta do Chatbot (Alterar essa parte pode resultar em uma m√° formata√ß√£o das respostas do Chatbot)
function escapeHtml(s) {
    return s
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

// Fun√ß√£o que formata a resposta do Chatbot (Alterar essa parte pode resultar em uma m√° formata√ß√£o das respostas do Chatbot)
function formatResponse(text) {
    if (!text) return "";

    text = text.replace(/\r\n/g, "\n");

    const codeBlocks = [];
    const PLACEHOLDER = "\uE000CODEBLOCK_";
    text = text.replace(/```([\w#+.\-]*)\n([\s\S]*?)```/g, (_, lang, code) => {
        const id = codeBlocks.push({ lang: (lang || "").trim(), code }) - 1;
        return `${PLACEHOLDER}${id}\uE000`;
    });

    let html = escapeHtml(text);

    html = html.replace(/^###### (.*)$/gm, "<h6>$1</h6>");
    html = html.replace(/^##### (.*)$/gm, "<h5>$1</h5>");
    html = html.replace(/^#### (.*)$/gm, "<h4>$1</h4>");
    html = html.replace(/^### (.*)$/gm, "<h3>$1</h3>");
    html = html.replace(/^## (.*)$/gm, "<h2>$1</h2>");
    html = html.replace(/^# (.*)$/gm, "<h1>$1</h1>");

    html = html.replace(/(?:^|\n)[\*\-] (.*)/g, (m, item) => `<li>${item}</li>`);
    html = html.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");

    html = html.replace(/(?:^|\n)\d+\. (.*)/g, (m, item) => `<li>${item}</li>`);
    html = html.replace(/(<li>.*<\/li>)/gs, (match) => {
        if (match.includes("<ul>")) return match;
        return `<ol>${match}</ol>`;
    });


    html = html.replace(/`([^`]+)`/g, (_, c) => `<code>${escapeHtml(c)}</code>`);

    html = html.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
    html = html.replace(/\*([^*]+)\*/g, "<em>$1</em>");

    html = html.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

    html = html
        .split(/\n{2,}/) 
        .map(p => `<p>${p.trim()}</p>`)
        .join("");

    html = html.replace(/\uE000CODEBLOCK_(\d+)\uE000/g, (_, idx) => {
        const { lang, code } = codeBlocks[Number(idx)];
        const safe = escapeHtml(code);
        const cls = lang ? ` class="language-${lang}"` : "";
        return `<pre><code${cls}>${safe}</code></pre>`;
    });

    return html;
}

// Fun√ß√£o que envia a mensagem do usu√°rio e recebe a resposta do Chatbot (Alterar essa parte pode resultar em um erro de funcionamento interno do Chatbot)
async function sendMessage(mode) {
    const inputField = document.getElementById(`${mode}Input`);
    const messagesContainer = document.getElementById(`${mode}Messages`);
    const userMessage = inputField.value.trim();
    if (!userMessage) return;

    messagesContainer.innerHTML += `<div class="message user-message text-end mb-2"><strong>üë§ User:</strong> ${escapeHtml(userMessage)}</div>`;
    inputField.value = '';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    const loadingId = Date.now();
    messagesContainer.innerHTML += `<div class="message bot-message mb-2" id="loading-${loadingId}"><strong>ü§ñ Assistente:</strong> ...</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    const loadingInterval = startLoadingAnimation(`loading-${loadingId}`);
    try {
        let botResponse = "";

        if (mode === "resumo") {
            const { model, system } = modeConfig.resumo;
            botResponse = await callOpenRouter({ model, system, userMessage, apiKey: apiKeys.openrouter });

        } else if (mode === "programa") {
            const { model, system } = modeConfig.programa;
            botResponse = await callOpenRouter({ model, system, userMessage, apiKey: apiKeys.openrouter2 });

        } else if (mode === "pesquisa") {
            const { model, system } = modeConfig.pesquisa;
            botResponse = await callOpenRouter({ model, system, userMessage, apiKey: apiKeys.openrouter3 });
        }

        stopLoadingAnimation(loadingInterval);
        document.getElementById(`loading-${loadingId}`)?.remove();
        const safeHtml = formatResponse(botResponse || "Desculpe, n√£o consegui gerar uma resposta.");
        messagesContainer.innerHTML += `<div class="message bot-message mb-2"><strong>ü§ñ Assistente:</strong><br>${safeHtml}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;


    } catch (error) {
        document.getElementById(`loading-${loadingId}`)?.remove();
        messagesContainer.innerHTML += `<div class="message bot-message mb-2 text-danger"><strong>‚ùå Erro:</strong> ${escapeHtml(error.message)}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Fun√ß√£o que inicia a anima√ß√£o de carregamento (Alterar essa parte pode resultar em uma m√° experi√™ncia visual do Chatbot)
function startLoadingAnimation(containerId) {
    const loadingEl = document.getElementById(containerId);
    if (!loadingEl) return;

    let dots = 0;
    const interval = setInterval(() => {
        dots = (dots + 1) % 4; 
        loadingEl.innerHTML = `<strong>ü§ñ Assistente:</strong> ${'.'.repeat(dots)}`;
    }, 500); 

    return interval; 
}

function stopLoadingAnimation(interval) {
    clearInterval(interval);
}

  </script>
</body>

</html>